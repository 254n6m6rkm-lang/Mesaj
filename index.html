<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Mesaj PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      padding: 16px;
      border-bottom: 1px solid #1f2937;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }
    .header h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }
    .status {
      font-size: 12px;
      color: #9ca3af;
    }
    .section {
      padding: 12px 16px;
      border-bottom: 1px solid #111827;
    }
    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .07em;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    input[type="text"]::placeholder { color: #4b5563; }
    button {
      padding: 8px 10px;
      border-radius: 10px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
      background: #4f46e5;
    }
    button.secondary { background: #111827; border: 1px solid #1f2937; }
    button:active { transform: scale(0.97); }

    .room-info {
      font-size: 12px;
      color: #9ca3af;
      word-break: break-all;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px 12px;
      background: radial-gradient(circle at top left, #020617, #000);
    }
    .message {
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 14px;
      margin-bottom: 6px;
      font-size: 14px;
      line-height: 1.35;
      word-wrap: break-word;
    }
    .mine {
      margin-left: auto;
      background: #4f46e5;
    }
    .other {
      margin-right: auto;
      background: #111827;
    }
    .time {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
      text-align: right;
    }

    form.send {
      display: flex;
      gap: 8px;
      padding: 10px 12px 12px;
      border-top: 1px solid #111827;
      background: #020617;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Mesaj PWA</h1>
    <div class="status" id="status">Firebase bağlanıyor…</div>
  </div>

  <div class="section">
    <div class="section-title">Oda</div>
    <div class="row">
      <button id="btn-new">Yeni oda</button>
      <input id="room-input" type="text" placeholder="Oda ID yaz veya oluştur">
      <button class="secondary" id="btn-join">Katıl</button>
    </div>
    <div class="room-info" id="room-info">Henüz oda seçmedin.</div>
  </div>

  <div class="section">
    <div class="section-title">Paylaşılabilir bağlantı</div>
    <div class="room-info" id="share-link">Odaya girdikten sonra burada görünecek.</div>
  </div>

  <div class="messages" id="messages"></div>

  <form class="send" id="send-form">
    <input id="msg-input" type="text" placeholder="Mesaj yaz…" autocomplete="off">
    <button type="submit">Gönder</button>
  </form>
</div>

<!-- Firebase compat scriptleri -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Senin Firebase ayarların -->
<script src="firebase-config.js"></script>

<!-- Firebase ile konuşan yardımcı fonksiyonlar -->
<script src="firebase-app.js"></script>

<!-- UI mantığı -->
<script>
  const statusEl = document.getElementById('status');
  const roomInput = document.getElementById('room-input');
  const btnNew = document.getElementById('btn-new');
  const btnJoin = document.getElementById('btn-join');
  const roomInfo = document.getElementById('room-info');
  const shareLinkEl = document.getElementById('share-link');
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('send-form');
  const msgInput = document.getElementById('msg-input');

  let currentRoomId = null;
  let unsubscribe = null;

  window.addEventListener('load', () => {
    if (window.chatApi && window.chatApi.ensureAuth) {
      window.chatApi.ensureAuth().then(u => {
        statusEl.textContent = 'Bağlı (Anonim UID: ' + u.uid.slice(0,8) + '…)';
      }).catch(() => {
        statusEl.textContent = 'Firebase bağlantı hatası';
      });
    } else {
      statusEl.textContent = 'chatApi yüklenemedi';
    }

    const hash = window.location.hash;
    if (hash.startsWith('#room=')) {
      const roomId = hash.replace('#room=', '').trim();
      if (roomId) {
        roomInput.value = roomId;
        joinRoom(roomId);
      }
    }
  });

  function renderMessage(text, mine, ts) {
    const wrap = document.createElement('div');
    const bubble = document.createElement('div');
    const time = document.createElement('div');

    bubble.className = 'message ' + (mine ? 'mine' : 'other');
    bubble.textContent = text;

    time.className = 'time';
    const d = new Date(ts || Date.now());
    time.textContent = d.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});

    wrap.appendChild(bubble);
    wrap.appendChild(time);
    messagesEl.appendChild(wrap);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function startRoom(roomId) {
    currentRoomId = roomId;
    roomInfo.textContent = 'Aktif oda: ' + roomId;
    roomInput.value = roomId;

    const baseUrl = window.location.origin + window.location.pathname;
    const share = baseUrl + '#room=' + encodeURIComponent(roomId);
    shareLinkEl.textContent = share;

    messagesEl.innerHTML = '';
    if (unsubscribe) unsubscribe();

    unsubscribe = window.chatApi.subscribeRoom(roomId, (text, mine, ts) => {
      renderMessage(text, mine, ts);
    });
  }

  async function joinRoom(roomId) {
    if (!window.chatApi) return;
    try {
      statusEl.textContent = 'Odaya katılınıyor…';
      await window.chatApi.joinRoom(roomId);
      startRoom(roomId);
      statusEl.textContent = 'Odaya katıldın: ' + roomId;
    } catch (e) {
      console.error(e);
      alert('Odaya katılamadın: ' + e.message);
      statusEl.textContent = 'Hata: ' + e.message;
    }
  }

  btnNew.addEventListener('click', async () => {
    if (!window.chatApi) return;
    const roomId = Math.random().toString(36).slice(2, 10);
    try {
      statusEl.textContent = 'Oda oluşturuluyor…';
      await window.chatApi.createRoom(roomId);
      startRoom(roomId);
      statusEl.textContent = 'Yeni oda oluşturuldu: ' + roomId;
    } catch (e) {
      console.error(e);
      alert('Oda oluşturulamadı: ' + e.message);
      statusEl.textContent = 'Hata: ' + e.message;
    }
  });

  btnJoin.addEventListener('click', () => {
    const roomId = roomInput.value.trim();
    if (!roomId) {
      alert('Katılmak için oda ID yaz.');
      return;
    }
    joinRoom(roomId);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if (!text) return;
    if (!currentRoomId) {
      alert('Önce bir oda oluştur veya odaya katıl.');
      return;
    }
    try {
      await window.chatApi.sendToCloud(currentRoomId, text);
      msgInput.value = '';
    } catch (e) {
      console.error(e);
      alert('Mesaj gönderilemedi: ' + e.message);
    }
  });
</script>

</body>
</html>
