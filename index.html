<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>BATUCHAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#020617" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --surface: #020617;
      --border: #1f2937;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.06);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
    }
    .light {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --surface: #ffffff;
      --border: #d1d5db;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.08);
      --text: #111827;
      --muted: #6b7280;
      --danger: #b91c1c;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 900px;
      background: var(--bg-soft);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: radial-gradient(circle at top, #0f172a, #020617);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .header h1 {
      font-size: 18px;
    }
    .status {
      font-size: 11px;
      color: var(--muted);
    }
    .header-buttons {
      display: flex;
      gap: 6px;
    }
    .icon-btn {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: rgba(15, 23, 42, 0.75);
      color: #e5e7eb;
      cursor: pointer;
    }
    .light .icon-btn {
      background: #e5e7eb;
      color: #111827;
      border-color: #d1d5db;
    }

    .layout {
      display: flex;
      min-height: 520px;
      max-height: calc(100vh - 100px);
    }

    /* Sol oda listesi */
    .sidebar {
      width: 34%;
      min-width: 230px;
      border-right: 1px solid var(--border);
      background: #020617;
      display: flex;
      flex-direction: column;
    }
    .light .sidebar {
      background: #f9fafb;
    }
    .sidebar-top {
      padding: 10px 10px 8px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-top-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .09em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .sidebar input[type="text"] {
      flex: 1;
      padding: 7px 9px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    .light .sidebar input[type="text"] {
      background: #ffffff;
      color: #111827;
    }
    .sidebar input[type="text"]::placeholder { color: #4b5563; }
    .light .sidebar input[type="text"]::placeholder { color: #9ca3af; }

    button {
      padding: 7px 10px;
      border-radius: 11px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
      background: var(--accent);
      cursor: pointer;
    }
    button.secondary {
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .light button.secondary {
      background: #f3f4f6;
    }
    button.danger {
      background: var(--danger);
    }
    button:active { transform: scale(0.97); }

    .room-info-small {
      font-size: 11px;
      color: var(--muted);
      padding: 0 2px 4px;
    }

    .room-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .room-item {
      width: 100%;
      text-align: left;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px 9px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }
    .light .room-item {
      background: #ffffff;
    }
    .room-item:hover {
      background: rgba(31, 41, 55, 0.9);
    }
    .light .room-item:hover {
      background: #e5e7eb;
    }
    .room-item.active {
      background: rgba(79, 70, 229, 0.35);
      border-color: rgba(79, 70, 229, 0.7);
    }
    .light .room-item.active {
      background: rgba(79, 70, 229, 0.18);
    }

    .room-main-click {
      display: flex;
      flex-direction: column;
      gap: 3px;
      cursor: pointer;
    }

    .room-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }
    .room-id {
      font-size: 13px;
      font-weight: 500;
    }
    .room-meta {
      font-size: 11px;
      color: var(--muted);
    }
    .room-id-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }
    .room-id-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .badge {
      min-width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .tiny-icon-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      padding: 0 3px;
      border-radius: 999px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .tiny-icon-btn:hover {
      background: rgba(148, 163, 184, 0.16);
    }

    /* SaÄŸ taraf: sohbet paneli */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top left, #020617, #000);
    }
    .light .chat-panel {
      background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    }

    .chat-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .chat-room-title {
      font-size: 14px;
      font-weight: 500;
    }
    .chat-room-sub {
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 10px 12px;
    }

    .msg-wrap {
      display: flex;
      flex-direction: column;
      max-width: 82%;
      margin-bottom: 6px;
    }
    .msg-wrap.mine { margin-left: auto; align-items: flex-end; }
    .msg-wrap.other { margin-right: auto; align-items: flex-start; }

    .msg-meta {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .message {
      padding: 7px 9px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.35;
      word-wrap: break-word;
      background: #111827;
      color: #e5e7eb;
    }
    .msg-wrap.mine .message {
      background: var(--accent);
    }
    .light .msg-wrap.other .message {
      background: #e5e7eb;
      color: #111827;
    }

    .message img {
      max-width: 220px;
      border-radius: 10px;
      display: block;
    }

    .time {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .msg-actions {
      display: flex;
      gap: 6px;
      margin-top: 2px;
    }
    .msg-action-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      padding: 0;
      cursor: pointer;
    }

    form.send {
      display: flex;
      gap: 6px;
      padding: 8px 10px 10px;
      border-top: 1px solid var(--border);
      background: var(--bg-soft);
    }
    .send-left {
      flex: 1;
      display: flex;
      gap: 6px;
    }
    .send-left input {
      flex: 1;
    }

    .send-left input[type="text"] {
      padding: 8px 10px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .light .send-left input[type="text"] {
      background: #ffffff;
      color: #111827;
    }
    .send-left input[type="text"]::placeholder { color: #4b5563; }
    .light .send-left input[type="text"]::placeholder { color: #9ca3af; }

    .send-tool-btn {
      width: 34px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      color: var(--muted);
      font-size: 16px;
      cursor: pointer;
    }
    .light .send-tool-btn {
      background: #e5e7eb;
      color: #4b5563;
    }

    /* Ayarlar sheet */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.65);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 20;
    }
    .overlay.visible { display: flex; }
    .sheet {
      width: 100%;
      max-width: 430px;
      background: var(--surface);
      border-radius: 18px 18px 0 0;
      border-top: 1px solid var(--border);
      box-shadow: 0 -16px 40px rgba(0,0,0,0.6);
      padding: 14px 16px 18px;
    }
    .sheet-title {
      font-size: 15px;
      margin-bottom: 8px;
    }
    .sheet-row {
      margin-bottom: 10px;
    }
    .sheet-row label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 3px;
    }
    .sheet-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    @media (max-width: 720px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        min-width: 0;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }
  
    .room-item, .room-main-click {
      cursor: pointer;
      pointer-events: auto;
    }

  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title-wrap">
      <h1>BATUCHAT</h1>
      <div class="status" id="status">Firebase baÄŸlanÄ±yorâ€¦</div>
    </div>
    <div class="header-buttons">
      <button class="icon-btn" id="btn-theme" title="Tema deÄŸiÅŸtir">â˜¾</button>
      <button class="icon-btn" id="btn-notify" title="Bildirimler">ðŸ””</button>
      <button class="icon-btn" id="btn-settings" title="Ayarlar">âš™</button>
    </div>
  </div>

  <div class="layout">
    <!-- SOL: ODALAR -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="sidebar-top-title">Odalar</div>
        <div class="row">
          <button id="btn-new">Yeni</button>
          <input id="room-input" type="text" placeholder="Oda ID ile git" />
        </div>
        <div class="row">
          <button class="secondary" id="btn-join" style="flex:1;">Bu odaya git</button>
        </div>
        <div class="room-info-small" id="room-info">HenÃ¼z oda seÃ§medin.</div>
      </div>
      <div class="room-list" id="room-list"></div>
    </aside>

    <!-- SAÄž: MESAJLAR -->
    <section class="chat-panel">
      <div class="chat-header">
        <div class="chat-room-title" id="chat-room-title">Oda seÃ§ilmedi</div>
        <div class="chat-room-sub" id="share-link">
          Odaya girdikten sonra paylaÅŸÄ±labilir baÄŸlantÄ± burada gÃ¶rÃ¼necek.
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <form class="send" id="send-form">
        <div class="send-left">
          <button type="button" class="send-tool-btn" id="btn-image" title="GÃ¶rsel ekle">ðŸ“·</button>
          <input id="msg-input" type="text" placeholder="Mesaj yazâ€¦" autocomplete="off" />
        </div>
        <button type="submit">GÃ¶nder</button>
      </form>
    </section>
  </div>
</div>

<!-- Ayarlar sheet -->
<div class="overlay" id="settings-overlay">
  <div class="sheet">
    <div class="sheet-title">Ayarlar</div>
    <div class="sheet-row">
      <label for="display-name-input">GÃ¶rÃ¼nen adÄ±n</label>
      <input id="display-name-input" type="text" placeholder="Ã–rn: Batuhan" />
    </div>
    <div class="sheet-buttons">
      <button type="button" class="secondary" id="btn-close-settings">Kapat</button>
      <button type="button" id="btn-save-settings">Kaydet</button>
    </div>
  </div>
</div>

<!-- Firebase compat scriptleri -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Proje ayarlarÄ±n -->
<script src="firebase-config.js"></script>

<!-- Firebase yardÄ±mcÄ± fonksiyonlar -->
<script src="firebase-app.js"></script>

<!-- UI mantÄ±ÄŸÄ± -->
<script>
  const statusEl = document.getElementById('status');
  const roomInput = document.getElementById('room-input');
  const btnNew = document.getElementById('btn-new');
  const btnJoin = document.getElementById('btn-join');
  const roomInfo = document.getElementById('room-info');
  const roomListEl = document.getElementById('room-list');
  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('send-form');
  const msgInput = document.getElementById('msg-input');

  const chatRoomTitle = document.getElementById('chat-room-title');
  const shareLinkEl = document.getElementById('share-link');

  const btnTheme = document.getElementById('btn-theme');
  const btnNotify = document.getElementById('btn-notify');
  const btnSettings = document.getElementById('btn-settings');
  const settingsOverlay = document.getElementById('settings-overlay');
  const btnCloseSettings = document.getElementById('btn-close-settings');
  const btnSaveSettings = document.getElementById('btn-save-settings');
  const displayNameInput = document.getElementById('display-name-input');
  const btnImage = document.getElementById('btn-image');

  let currentRoomId = null;
  let currentRoomName = null;
  let unsubscribe = null;
  let messagesMap = new Map();       // mesajlar
  let roomsMap = new Map();          // oda listesi
  let lastReadCounts = {};           // {roomId: messageCount}
  let notificationsEnabled = false;

  function loadTheme() {
    try {
      const t = localStorage.getItem('theme') || 'dark';
      if (t === 'light') {
        document.body.classList.add('light');
        btnTheme.textContent = 'â˜€';
      } else {
        document.body.classList.remove('light');
        btnTheme.textContent = 'â˜¾';
      }
    } catch {}
  }

  function toggleTheme() {
    const isLight = document.body.classList.toggle('light');
    btnTheme.textContent = isLight ? 'â˜€' : 'â˜¾';
    try {
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    } catch {}
  }

  function loadDisplayName() {
    try {
      const name = localStorage.getItem('displayName') || '';
      displayNameInput.value = name;
    } catch {}
  }

  function saveDisplayName() {
    const name = displayNameInput.value.trim();
    try {
      localStorage.setItem('displayName', name);
    } catch {}
  }

  function showSettings() {
    loadDisplayName();
    settingsOverlay.classList.add('visible');
  }
  function hideSettings() {
    settingsOverlay.classList.remove('visible');
  }

  function loadLastReadCounts() {
    try {
      const raw = localStorage.getItem('lastReadCounts');
      lastReadCounts = raw ? JSON.parse(raw) : {};
    } catch {
      lastReadCounts = {};
    }
  }
  function saveLastReadCounts() {
    try {
      localStorage.setItem('lastReadCounts', JSON.stringify(lastReadCounts));
    } catch {}
  }

  function maybeNotify(text) {
    if (!notificationsEnabled) return;
    if (!('Notification' in window)) return;
    if (document.visibilityState === 'visible') return; // ekran aÃ§Ä±kken gerek yok
    new Notification(currentRoomName || 'BATUCHAT', {
      body: text,
    });
  }

  function requestNotifications() {
    if (!('Notification' in window)) {
      alert('TarayÄ±cÄ± bildirim desteklemiyor.');
      return;
    }
    if (Notification.permission === 'granted') {
      notificationsEnabled = true;
      alert('Bildirimler zaten aÃ§Ä±k.');
      return;
    }
    if (Notification.permission === 'denied') {
      alert('Bildirimler tarayÄ±cÄ±da engellenmiÅŸ.');
      return;
    }
    Notification.requestPermission().then(p => {
      if (p === 'granted') {
        notificationsEnabled = true;
        alert('Bildirimler aÃ§Ä±ldÄ±.');
      }
    });
  }

  function copyRoomIdToClipboard(roomId) {
    if (!navigator.clipboard) {
      alert('Kopyalama desteklenmiyor. ID: ' + roomId);
      return;
    }
    navigator.clipboard.writeText(roomId).then(() => {
      statusEl.textContent = 'Oda ID kopyalandÄ±: ' + roomId;
    }).catch(() => {
      alert('KopyalanamadÄ±. ID: ' + roomId);
    });
  }

  async function renameRoomFromUI(room) {
    if (!window.chatApi || !window.chatApi.renameRoom) return;
    const mevcut = room.roomName || room.id;
    const yeni = prompt('Oda ismini yaz:', mevcut);
    if (!yeni) return;
    try {
      await window.chatApi.renameRoom(room.id, yeni.trim());
    } catch (e) {
      alert('Oda ismi deÄŸiÅŸtirilirken hata: ' + e.message);
    }
  }

  function renderRoomList() {
    roomListEl.innerHTML = '';
    if (!roomsMap.size) {
      const empty = document.createElement('div');
      empty.className = 'room-info-small';
      empty.style.padding = '10px';
      empty.textContent = 'HenÃ¼z oda yok. Yeni oda oluÅŸtur.';
      roomListEl.appendChild(empty);
      return;
    }

    // Son mesaj zamanÄ±na gÃ¶re sÄ±ralama
    const rooms = Array.from(roomsMap.values()).sort((a, b) => {
      const ta = a.lastMessageAt ? a.lastMessageAt.getTime() : 0;
      const tb = b.lastMessageAt ? b.lastMessageAt.getTime() : 0;
      return tb - ta;
    });

    rooms.forEach(r => {
      const wrapper = document.createElement('div');
      wrapper.className = 'room-item' + (r.id === currentRoomId ? ' active' : '');

      // Oda adÄ±na tÄ±klandÄ±ÄŸÄ±nda sohbet aÃ§an alan
      const mainClick = document.createElement('div');
      mainClick.className = 'room-main-click';

      const line = document.createElement('div');
      line.className = 'room-line';

      const title = document.createElement('div');
      title.className = 'room-id';
      title.textContent = r.roomName || r.id;

      const total = r.messageCount || 0;
      const readCount = lastReadCounts[r.id] || 0;
      const unread = Math.max(0, total - readCount);

      if (unread > 0) {
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.textContent = unread > 9 ? '9+' : String(unread);
        line.appendChild(title);
        line.appendChild(badge);
      } else {
        line.appendChild(title);
      }

      // Ä°sim dÃ¼zenleme butonu
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'tiny-icon-btn';
      editBtn.textContent = 'âœŽ';
      editBtn.title = 'Oda ismini deÄŸiÅŸtir';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        renameRoomFromUI(r);
      });

      line.appendChild(editBtn);

      const meta = document.createElement('div');
      meta.className = 'room-meta';
      if (r.lastMessageAt) {
        meta.textContent =
          'Son mesaj: ' +
          r.lastMessageAt.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
      } else {
        meta.textContent = 'HenÃ¼z mesaj yok';
      }

      mainClick.appendChild(line);
      mainClick.appendChild(meta);

      // ID satÄ±rÄ± (kopyala butonu)
      const idRow = document.createElement('div');
      idRow.className = 'room-id-row';

      const idText = document.createElement('span');
      idText.className = 'room-id-text';
      idText.textContent = 'ID: ' + r.id;

      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.className = 'tiny-icon-btn';
      copyBtn.textContent = 'â§‰';
      copyBtn.title = 'Oda ID kopyala';
      copyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        copyRoomIdToClipboard(r.id);
      });

      idRow.appendChild(idText);
      idRow.appendChild(copyBtn);

      wrapper.appendChild(mainClick);
      wrapper.appendChild(idRow);

      wrapper.onclick = (e) => {
        if (e.target.closest(".tiny-icon-btn")) return;
        joinRoom(r.id);
      };

      roomListEl.appendChild(wrapper);
    });
  }

  function renderMessageNode(msg) {
    const wrap = document.createElement('div');
    wrap.className = 'msg-wrap ' + (msg.mine ? 'mine' : 'other');
    wrap.dataset.id = msg.id;

    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    const d = msg.createdAt || new Date();
    const timeStr = d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    meta.textContent = (msg.userName || 'Anonim') + ' â€¢ ' + timeStr + (msg.editedAt ? ' (dÃ¼zenlendi)' : '');

    const bubble = document.createElement('div');
    bubble.className = 'message';

    if (msg.type === 'image') {
      const img = document.createElement('img');
      img.src = msg.text;
      img.alt = 'gÃ¶rsel';
      bubble.appendChild(img);
    } else {
      bubble.textContent = msg.text;
    }

    wrap.appendChild(meta);
    wrap.appendChild(bubble);

    if (msg.mine) {
      const actions = document.createElement('div');
      actions.className = 'msg-actions';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'msg-action-btn';
      editBtn.textContent = 'DÃ¼zenle';
      editBtn.addEventListener('click', () => onEditMessage(msg.id));

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'msg-action-btn';
      delBtn.textContent = 'Sil';
      delBtn.addEventListener('click', () => onDeleteMessage(msg.id));

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
      wrap.appendChild(actions);
    }

    return wrap;
  }

  function upsertMessage(msg) {
    let existing = messagesMap.get(msg.id);
    if (!existing) {
      const node = renderMessageNode(msg);
      messagesMap.set(msg.id, node);
      messagesEl.appendChild(node);
    } else {
      const newNode = renderMessageNode(msg);
      messagesEl.replaceChild(newNode, existing);
      messagesMap.set(msg.id, newNode);
    }
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function removeMessageNode(id) {
    const node = messagesMap.get(id);
    if (node && node.parentNode) {
      node.parentNode.removeChild(node);
    }
    messagesMap.delete(id);
  }

  function startRoom(roomId) {
    currentRoomId = roomId;
    const room = roomsMap.get(roomId);
    currentRoomName = room ? room.roomName : roomId;

    roomInfo.textContent = 'Aktif oda: ' + (currentRoomName || roomId);
    chatRoomTitle.textContent = currentRoomName || ('Oda: ' + roomId);
    roomInput.value = roomId;

    const baseUrl = window.location.origin + window.location.pathname;
    const share = baseUrl + '#room=' + encodeURIComponent(roomId);
    shareLinkEl.textContent = share;

    messagesMap.clear();
    messagesEl.innerHTML = '';
    if (unsubscribe) unsubscribe();

    // odaya girince: okundu sayÄ±sÄ±nÄ± gÃ¼ncelle
    const total = room && room.messageCount ? room.messageCount : 0;
    lastReadCounts[roomId] = total;
    saveLastReadCounts();
    renderRoomList();

    unsubscribe = window.chatApi.subscribeRoom(roomId, (msg) => {
      if (msg.changeType === 'removed') {
        removeMessageNode(msg.id);
      } else {
        upsertMessage(msg);
        if (!msg.mine) {
          maybeNotify(msg.text);
        }
      }
    });
  }

  async function joinRoom(roomId) {
    if (!window.chatApi) return;
    try {
      statusEl.textContent = 'Odaya katÄ±lÄ±nÄ±yorâ€¦';
      await window.chatApi.joinRoom(roomId);
      startRoom(roomId);
      statusEl.textContent = 'Odaya katÄ±ldÄ±n: ' + roomId;
    } catch (e) {
      console.error(e);
      alert('Odaya katÄ±lamadÄ±n: ' + e.message);
      statusEl.textContent = 'Hata: ' + e.message;
    }
  }

  async function onEditMessage(id) {
    if (!currentRoomId) return;
    const node = messagesMap.get(id);
    if (!node) return;
    const bubble = node.querySelector('.message');
    const currentText = bubble ? bubble.textContent : '';
    const yeni = prompt('MesajÄ± dÃ¼zenle:', currentText);
    if (yeni == null) return;
    const text = yeni.trim();
    if (!text) return;
    try {
      await window.chatApi.updateMessage(currentRoomId, id, text);
    } catch (e) {
      alert('DÃ¼zenlenemedi: ' + e.message);
    }
  }

  async function onDeleteMessage(id) {
    if (!currentRoomId) return;
    if (!confirm('MesajÄ± silmek istiyor musun?')) return;
    try {
      await window.chatApi.deleteMessage(currentRoomId, id);
    } catch (e) {
      alert('Silinemedi: ' + e.message);
    }
  }

  async function sendMessage(type) {
    const text = msgInput.value.trim();
    if (!currentRoomId) {
      alert('Ã–nce soldan bir oda seÃ§ veya yeni oda oluÅŸtur.');
      return;
    }
    if (type === 'text') {
      if (!text) return;
      try {
        await window.chatApi.sendToCloud(currentRoomId, text, 'text', {});
        msgInput.value = '';
      } catch (e) {
        alert('Mesaj gÃ¶nderilemedi: ' + e.message);
      }
    } else if (type === 'image') {
      const url = prompt('GÃ¶rsel URL'si gir (https://...)');
      if (!url) return;
      try {
        await window.chatApi.sendToCloud(currentRoomId, url.trim(), 'image', {});
      } catch (e) {
        alert('GÃ¶rsel gÃ¶nderilemedi: ' + e.message);
      }
    }
  }

  window.addEventListener('load', async () => {
    loadTheme();
    loadLastReadCounts();

    if (window.chatApi && window.chatApi.ensureAuth) {
      try {
        const u = await window.chatApi.ensureAuth();
        statusEl.textContent = 'BaÄŸlÄ± (Anonim UID: ' + u.uid.slice(0, 6) + 'â€¦)';

        // KullanÄ±cÄ±nÄ±n odalarÄ±nÄ± dinle
        window.chatApi.subscribeMyRooms((room) => {
          const existing = roomsMap.get(room.id) || {};
          roomsMap.set(room.id, {
            ...existing,
            ...room,
          });
          renderRoomList();
        });
      } catch (e) {
        statusEl.textContent = 'Firebase baÄŸlantÄ± hatasÄ±';
      }
    } else {
      statusEl.textContent = 'chatApi yÃ¼klenemedi';
    }

    const hash = window.location.hash;
    if (hash.startsWith('#room=')) {
      const roomId = hash.replace('#room=', '').trim();
      if (roomId) {
        roomInput.value = roomId;
        joinRoom(roomId);
      }
    }
  });

  btnNew.addEventListener('click', async () => {
    if (!window.chatApi) return;
    const name = prompt('Oda adÄ± gir (Ã¶r: Aile, Ä°ÅŸ, ArkadaÅŸlar):');
    if (!name) return;
    try {
      statusEl.textContent = 'Oda oluÅŸturuluyorâ€¦';
      const roomId = await window.chatApi.createRoomWithName(name.trim());
      await joinRoom(roomId);
      statusEl.textContent = 'Yeni oda: ' + name;
    } catch (e) {
      console.error(e);
      alert('Oda oluÅŸturulamadÄ±: ' + e.message);
      statusEl.textContent = 'Hata: ' + e.message;
    }
  });

  btnJoin.addEventListener('click', () => {
    const roomId = roomInput.value.trim();
    if (!roomId) {
      alert('Gitmek iÃ§in oda ID yaz.');
      return;
    }
    joinRoom(roomId);
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendMessage('text');
  });

  btnImage.addEventListener('click', () => {
    sendMessage('image');
  });

  btnTheme.addEventListener('click', toggleTheme);
  btnSettings.addEventListener('click', showSettings);
  btnCloseSettings.addEventListener('click', hideSettings);
  settingsOverlay.addEventListener('click', (e) => {
    if (e.target === settingsOverlay) hideSettings();
  });
  btnSaveSettings.addEventListener('click', () => {
    saveDisplayName();
    hideSettings();
  });

  btnNotify.addEventListener('click', requestNotifications);
</script>
</body>
</html>
